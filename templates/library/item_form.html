{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_edit %}Edit {{ item.title }}{% else %}Add New Item{% endif %} - Stuff for Friends{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
{% endblock %}

{% block content %}
<div class="item-form-page">
    <h1>{% if is_edit %}Edit Item{% else %}Add New Item{% endif %}</h1>

    <form method="post" enctype="multipart/form-data" class="card mt-lg">
        {% csrf_token %}

        <div class="form-group">
            <label for="id_title">Title *</label>
            {{ form.title }}
            {% if form.title.errors %}
                <div class="form-errors">{{ form.title.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_short_description">Short Description</label>
            {{ form.short_description }}
            <div class="form-help">Shown on the gallery view. Keep it brief.</div>
            {% if form.short_description.errors %}
                <div class="form-errors">{{ form.short_description.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_long_description">Full Description</label>
            {{ form.long_description }}
            <div class="form-help">Shown on the item detail page.</div>
            {% if form.long_description.errors %}
                <div class="form-errors">{{ form.long_description.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_borrow_time_limit">Borrow Time Limit</label>
            {{ form.borrow_time_limit }}
            <div class="form-help">Optional. E.g., "2 weeks", "1 month", "Return by summer"</div>
            {% if form.borrow_time_limit.errors %}
                <div class="form-errors">{{ form.borrow_time_limit.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label>Image</label>
            <div class="form-help mb-sm">Images will be displayed at 4:3 aspect ratio. You can crop after selecting.</div>

            {% if is_edit and item.image %}
                <div class="current-image mb-md">
                    <p class="text-muted">Current image:</p>
                    <img src="{{ item.image.url }}" alt="{{ item.title }}" class="preview-thumb">
                </div>
            {% endif %}

            <input type="file" id="id_image" name="image" accept="image/*" class="file-input">

            <div id="crop-container" class="crop-container" style="display: none;">
                <img id="crop-image" src="" alt="Crop preview">
            </div>

            <input type="hidden" id="cropped_image" name="cropped_image">

            {% if form.image.errors %}
                <div class="form-errors">{{ form.image.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if is_edit %}Save Changes{% else %}Add Item{% endif %}
            </button>
            <a href="{% url 'library:item_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_image');
    const cropContainer = document.getElementById('crop-container');
    const cropImage = document.getElementById('crop-image');
    let cropper = null;

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            cropContainer.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            cropImage.src = event.target.result;
            cropContainer.style.display = 'block';

            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(cropImage, {
                aspectRatio: 4 / 3,
                viewMode: 2,
                autoCropArea: 1,
                responsive: true,
                background: false,
            });
        };
        reader.readAsDataURL(file);
    });

    // Before form submit, get cropped image data
    document.querySelector('form').addEventListener('submit', function(e) {
        if (cropper) {
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 1200,
                maxHeight: 900,
            });

            if (canvas) {
                canvas.toBlob(function(blob) {
                    // Create a new file from the cropped blob
                    const croppedFile = new File([blob], 'cropped_image.jpg', { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(croppedFile);
                    fileInput.files = dataTransfer.files;
                }, 'image/jpeg', 0.9);
            }
        }
    });
});
</script>
{% endblock %}
